<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do Kanban - Tony's Personal Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 1.5rem;
        }
        
        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .back-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }
        .top-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #ccc;
        }
        .btn:hover { transform: translateY(-1px); }
        
        /* Header */
        header {
            margin-bottom: 1.5rem;
        }
        header h1 {
            font-size: 1.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .subtitle {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .filter-label {
            font-size: 0.8rem;
            color: #888;
        }
        .filter-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .filter-select option {
            background: #1a1a2e;
        }
        
        /* Kanban Board */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            min-height: calc(100vh - 200px);
        }
        
        /* Columns */
        .kanban-column {
            min-width: 280px;
            max-width: 320px;
            flex-shrink: 0;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        .column-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .column-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .column-count {
            background: rgba(255,255,255,0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #888;
        }
        .column-add {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            border-radius: 4px;
        }
        .column-add:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        /* Column Colors */
        .column-backlog .column-header { border-left: 3px solid #6b7280; }
        .column-today .column-header { border-left: 3px solid #f59e0b; }
        .column-progress .column-header { border-left: 3px solid #3b82f6; }
        .column-waiting .column-header { border-left: 3px solid #8b5cf6; }
        .column-done .column-header { border-left: 3px solid #10b981; }
        
        /* Card List */
        .card-list {
            flex: 1;
            padding: 0.75rem;
            min-height: 100px;
            overflow-y: auto;
        }
        
        /* Cards */
        .kanban-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
        }
        .kanban-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
        }
        .kanban-card.sortable-ghost {
            opacity: 0.4;
            background: rgba(102, 126, 234, 0.2);
        }
        .kanban-card.sortable-chosen {
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .kanban-card.filtered {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .card-header {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .card-handle {
            color: #555;
            cursor: grab;
            font-size: 1rem;
            flex-shrink: 0;
            padding: 0.1rem;
        }
        .card-handle:hover { color: #888; }
        .card-title {
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
            line-height: 1.3;
        }
        .card-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .priority-high { background: #ef4444; }
        .priority-medium { background: #f59e0b; }
        .priority-low { background: #6b7280; }
        
        .card-description {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .card-meta {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .card-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: #aaa;
        }
        .tag-agent {
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
        }
        .tag-category {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        /* Nested Subtasks */
        .card-subtasks {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .subtask {
            font-size: 0.8rem;
            color: #888;
            padding: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .subtask-checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid #555;
            border-radius: 3px;
            cursor: pointer;
        }
        .subtask-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: #1e2433;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body { padding: 1.5rem; }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.4rem;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 0.6rem;
            color: #fff;
            font-size: 0.9rem;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 1.5rem;
            color: #444;
            font-size: 0.8rem;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="top-bar">
        <a href="hub-tony.html" class="back-link">‚Üê Back to Tony's Dashboard Hub</a>
        <div class="top-actions">
            <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
            <button class="btn btn-secondary" onclick="importData()">üì§ Import</button>
            <button class="btn btn-primary" onclick="openAddModal()">+ Add Task</button>
        </div>
    </div>
    
    <header>
        <h1>üìã To-Do Kanban</h1>
        <p class="subtitle">Chief of Staff View ‚Äî Drag cards to update status</p>
    </header>
    
    <div class="filter-bar">
        <div class="filter-group">
            <span class="filter-label">Agent:</span>
            <select class="filter-select" id="filter-agent" onchange="applyFilters()">
                <option value="">All</option>
                <option value="greg">Greg (Chief of Staff)</option>
                <option value="coder">10x Coder</option>
                <option value="analyst">Tech Analyst</option>
                <option value="personal-os">Personal OS</option>
                <option value="tony">Tony</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Priority:</span>
            <select class="filter-select" id="filter-priority" onchange="applyFilters()">
                <option value="">All</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Category:</span>
            <select class="filter-select" id="filter-category" onchange="applyFilters()">
                <option value="">All</option>
                <option value="development">Development</option>
                <option value="research">Research</option>
                <option value="design">Design</option>
                <option value="operations">Operations</option>
                <option value="partnerships">Partnerships</option>
                <option value="personal">Personal</option>
            </select>
        </div>
    </div>
    
    <div class="kanban-board" id="kanban-board">
        <div class="kanban-column column-backlog" data-status="backlog">
            <div class="column-header">
                <span class="column-title">üì• Backlog <span class="column-count" id="count-backlog">0</span></span>
                <button class="column-add" onclick="openAddModal('backlog')">+</button>
            </div>
            <div class="card-list" id="list-backlog"></div>
        </div>
        
        <div class="kanban-column column-today" data-status="today">
            <div class="column-header">
                <span class="column-title">üéØ Today <span class="column-count" id="count-today">0</span></span>
                <button class="column-add" onclick="openAddModal('today')">+</button>
            </div>
            <div class="card-list" id="list-today"></div>
        </div>
        
        <div class="kanban-column column-progress" data-status="progress">
            <div class="column-header">
                <span class="column-title">üîÑ In Progress <span class="column-count" id="count-progress">0</span></span>
                <button class="column-add" onclick="openAddModal('progress')">+</button>
            </div>
            <div class="card-list" id="list-progress"></div>
        </div>
        
        <div class="kanban-column column-waiting" data-status="waiting">
            <div class="column-header">
                <span class="column-title">‚è≥ Waiting <span class="column-count" id="count-waiting">0</span></span>
                <button class="column-add" onclick="openAddModal('waiting')">+</button>
            </div>
            <div class="card-list" id="list-waiting"></div>
        </div>
        
        <div class="kanban-column column-done" data-status="done">
            <div class="column-header">
                <span class="column-title">‚úÖ Done <span class="column-count" id="count-done">0</span></span>
            </div>
            <div class="card-list" id="list-done"></div>
        </div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modal-title">Add Task</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="task-title" placeholder="Task title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="task-description" placeholder="Task details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="task-status">
                        <option value="backlog">Backlog</option>
                        <option value="today">Today</option>
                        <option value="progress">In Progress</option>
                        <option value="waiting">Waiting</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="task-priority">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Agent</label>
                    <select class="form-select" id="task-agent">
                        <option value="greg">Greg (Chief of Staff)</option>
                        <option value="coder">10x Coder</option>
                        <option value="analyst">Tech Analyst</option>
                        <option value="personal-os">Personal OS</option>
                        <option value="tony">Tony</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="task-category">
                        <option value="development">Development</option>
                        <option value="research">Research</option>
                        <option value="design">Design</option>
                        <option value="operations">Operations</option>
                        <option value="partnerships">Partnerships</option>
                        <option value="personal">Personal</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>
    
    <footer>
        To-Do Kanban ‚Ä¢ Tony's Personal Dashboard ‚Ä¢ Chief of Staff: Greg
    </footer>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase config - DIRECT CONNECTION
        const SUPABASE_URL = 'https://mmwbiogqmgmtxboipyko.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_r6q0-iEnygKZiZkaOuY-hg_Tvlb-66U';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const BOARD_NAME = 'todos';

        // Data
        let tasks = [];
        
        const AGENT_LABELS = {
            'greg': 'Greg',
            'coder': '10x Coder',
            'analyst': 'Tech Analyst',
            'personal-os': 'Personal OS',
            'tony': 'Tony'
        };
        
        // Initialize
        async function init() {
            await loadData();
            renderBoard();
            initSortable();
        }
        
        // Load from Supabase
        async function loadData() {
            try {
                const { data, error } = await db
                    .from('kanban_items')
                    .select('*')
                    .eq('board', BOARD_NAME)
                    .order('position', { ascending: true });
                
                if (error) throw error;
                
                // Map Supabase data to task format
                tasks = data.map(item => ({
                    id: item.item_id || item.id,
                    supabaseId: item.id,
                    status: item.column_id,
                    position: item.position,
                    ...(typeof item.data === 'string' ? JSON.parse(item.data) : item.data)
                }));
                
                console.log(`Loaded ${tasks.length} tasks from Supabase`);
            } catch (e) {
                console.error('Failed to load from Supabase:', e);
                tasks = [];
            }
        }
        
        // Save single task to Supabase
        async function saveTaskToSupabase(task, isNew = false) {
            const taskData = {
                title: task.title,
                description: task.description,
                priority: task.priority,
                agent: task.agent,
                category: task.category,
                source: task.source
            };
            
            try {
                if (isNew) {
                    const { error } = await db
                        .from('kanban_items')
                        .insert({
                            board: BOARD_NAME,
                            column_id: task.status,
                            item_id: String(task.id),
                            position: tasks.length,
                            data: taskData
                        });
                    if (error) throw error;
                } else {
                    const { error } = await db
                        .from('kanban_items')
                        .update({
                            column_id: task.status,
                            data: taskData
                        })
                        .eq('board', BOARD_NAME)
                        .eq('item_id', String(task.id));
                    if (error) throw error;
                }
            } catch (e) {
                console.error('Failed to save to Supabase:', e);
            }
        }
        
        // Update task status (for drag-drop)
        async function updateTaskStatus(taskId, newStatus) {
            try {
                const { error } = await db
                    .from('kanban_items')
                    .update({ column_id: newStatus })
                    .eq('board', BOARD_NAME)
                    .eq('item_id', String(taskId));
                if (error) throw error;
            } catch (e) {
                console.error('Failed to update status:', e);
            }
        }
        
        function renderBoard() {
            const statuses = ['backlog', 'today', 'progress', 'waiting', 'done'];
            const filters = {
                agent: document.getElementById('filter-agent').value,
                priority: document.getElementById('filter-priority').value,
                category: document.getElementById('filter-category').value
            };
            
            statuses.forEach(status => {
                const list = document.getElementById(`list-${status}`);
                const statusTasks = tasks.filter(t => t.status === status);
                
                list.innerHTML = statusTasks.map(task => {
                    const isFiltered = (filters.agent && task.agent !== filters.agent) ||
                                       (filters.priority && task.priority !== filters.priority) ||
                                       (filters.category && task.category !== filters.category);
                    
                    return `
                        <div class="kanban-card ${isFiltered ? 'filtered' : ''}" 
                             data-id="${task.id}" 
                             onclick="openEditModal(${task.id})">
                            <div class="card-header">
                                <span class="card-handle">‚â°</span>
                                <span class="card-title">${escapeHtml(task.title)}</span>
                                <span class="card-priority priority-${task.priority}"></span>
                            </div>
                            ${task.description ? `<div class="card-description">${escapeHtml(task.description)}</div>` : ''}
                            <div class="card-meta">
                                <span class="card-tag tag-agent">${AGENT_LABELS[task.agent] || task.agent}</span>
                                <span class="card-tag tag-category">${task.category}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById(`count-${status}`).textContent = statusTasks.length;
            });
        }
        
        function initSortable() {
            const lists = document.querySelectorAll('.card-list');
            lists.forEach(list => {
                new Sortable(list, {
                    group: 'kanban',
                    animation: 150,
                    handle: '.card-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    filter: '.filtered',
                    onEnd: async function(evt) {
                        const cardId = evt.item.dataset.id;
                        const newStatus = evt.to.id.replace('list-', '');
                        
                        const task = tasks.find(t => String(t.id) === String(cardId));
                        if (task) {
                            task.status = newStatus;
                            await updateTaskStatus(cardId, newStatus);
                            renderBoard();
                        }
                    }
                });
            });
        }
        
        function applyFilters() {
            renderBoard();
        }
        
        // Modal functions
        function openAddModal(status = 'backlog') {
            document.getElementById('modal-title').textContent = 'Add Task';
            document.getElementById('task-id').value = '';
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-status').value = status;
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-agent').value = 'greg';
            document.getElementById('task-category').value = 'development';
            document.getElementById('task-modal').classList.add('visible');
        }
        
        function openEditModal(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            document.getElementById('modal-title').textContent = 'Edit Task';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-agent').value = task.agent;
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-modal').classList.add('visible');
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.remove('visible');
        }
        
        async function saveTask() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value.trim();
            
            if (!title) {
                alert('Title is required');
                return;
            }
            
            const taskData = {
                id: id || Date.now(),
                title: title,
                description: document.getElementById('task-description').value.trim(),
                status: document.getElementById('task-status').value,
                priority: document.getElementById('task-priority').value,
                agent: document.getElementById('task-agent').value,
                category: document.getElementById('task-category').value
            };
            
            if (id) {
                // Edit existing
                const task = tasks.find(t => String(t.id) === String(id));
                if (task) {
                    Object.assign(task, taskData);
                    await saveTaskToSupabase(task, false);
                }
            } else {
                // Add new
                tasks.push(taskData);
                await saveTaskToSupabase(taskData, true);
            }
            
            renderBoard();
            closeModal();
        }
        
        function exportData() {
            const data = JSON.stringify(tasks, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanban-todos-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    try {
                        const imported = JSON.parse(text);
                        const tasksToImport = imported.tasks || imported;
                        
                        // Insert each task into Supabase
                        for (let i = 0; i < tasksToImport.length; i++) {
                            const task = tasksToImport[i];
                            const { error } = await db
                                .from('kanban_items')
                                .insert({
                                    board: BOARD_NAME,
                                    column_id: task.status || 'backlog',
                                    item_id: String(task.id || Date.now() + i),
                                    position: i,
                                    data: {
                                        title: task.title,
                                        description: task.description,
                                        priority: task.priority,
                                        agent: task.agent,
                                        category: task.category,
                                        source: task.source
                                    }
                                });
                            if (error) console.error('Import error:', error);
                        }
                        
                        await loadData();
                        renderBoard();
                        alert('Import successful!');
                    } catch (err) {
                        alert('Invalid JSON file: ' + err.message);
                    }
                }
            };
            input.click();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modal on outside click
        document.getElementById('task-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Init
        init();
    </script>
</body>
</html>
