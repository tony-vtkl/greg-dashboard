<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-City Living | Business Analyst</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 1.5rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        header { margin-bottom: 1.5rem; }
        .back-link { color: #667eea; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { text-decoration: underline; }
        h1 { font-size: 1.8rem; margin: 0.5rem 0; color: #fff; }
        .subtitle { color: #888; font-size: 0.9rem; }
        .source-note { color: #666; font-size: 0.8rem; margin-top: 0.25rem; }
        
        .toolbar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
        .btn { padding: 0.5rem 1rem; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #ccc; }
        
        .board { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; }
        .column {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .column-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .column-title { font-weight: 600; color: #fff; display: flex; align-items: center; gap: 0.5rem; }
        .column-count { background: rgba(255,255,255,0.1); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; }
        .add-btn { background: none; border: none; color: #667eea; cursor: pointer; font-size: 1.2rem; }
        
        .card-list { min-height: 100px; }
        .item-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .card-title { font-weight: 600; color: #fff; margin-bottom: 0.5rem; }
        .card-content { color: #aaa; font-size: 0.85rem; line-height: 1.5; }
        .card-meta { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .tag { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; }
        .tag-housing { background: rgba(102, 126, 234, 0.3); color: #a8b4f0; }
        .tag-economics { background: rgba(46, 213, 115, 0.3); color: #7ee8a8; }
        .tag-deepwork { background: rgba(245, 87, 108, 0.3); color: #f8a8b6; }
        .tag-tax { background: rgba(255, 184, 108, 0.3); color: #ffd093; }
        
        .stats-bar {
            display: flex; gap: 2rem; margin-bottom: 1.5rem; padding: 1rem;
            background: rgba(0,0,0,0.2); border-radius: 8px; flex-wrap: wrap;
        }
        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #2ed573; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.visible { display: flex; }
        .modal-content { background: #1e1e2e; border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: #888; font-size: 0.85rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); color: #fff; font-size: 0.9rem;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
        
        footer { text-align: center; padding: 2rem 0 1rem; color: #555; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <a href="hub-tony.html" class="back-link">‚Üê Back to Dashboard Hub</a>
        <header>
            <h1>üåè Multi-City Living Strategy</h1>
            <p class="subtitle">Executive Nomad Housing + Deep Work Immersions</p>
            <p class="source-note">Source: Grok conversation ‚Ä¢ Business Analyst Agent</p>
        </header>
        
        <div class="stats-bar">
            <div class="stat"><div class="stat-value">$29K+</div><div class="stat-label">Annual Savings</div></div>
            <div class="stat"><div class="stat-value">70%</div><div class="stat-label">Rent Write-off</div></div>
            <div class="stat"><div class="stat-value">3x/yr</div><div class="stat-label">Deep Work Sessions</div></div>
            <div class="stat"><div class="stat-value">4</div><div class="stat-label">Cities</div></div>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="openAddModal()">+ Add Item</button>
            <button class="btn btn-secondary" onclick="exportData()">üì§ Export</button>
        </div>
        
        <div class="board">
            <div class="column">
                <div class="column-header">
                    <span class="column-title">üè† Housing <span class="column-count" id="count-housing">0</span></span>
                    <button class="add-btn" onclick="openAddModal('housing')">+</button>
                </div>
                <div class="card-list" id="list-housing"></div>
            </div>
            <div class="column">
                <div class="column-header">
                    <span class="column-title">üí∞ Economics <span class="column-count" id="count-economics">0</span></span>
                    <button class="add-btn" onclick="openAddModal('economics')">+</button>
                </div>
                <div class="card-list" id="list-economics"></div>
            </div>
            <div class="column">
                <div class="column-header">
                    <span class="column-title">üß† Deep Work <span class="column-count" id="count-deepwork">0</span></span>
                    <button class="add-btn" onclick="openAddModal('deepwork')">+</button>
                </div>
                <div class="card-list" id="list-deepwork"></div>
            </div>
            <div class="column">
                <div class="column-header">
                    <span class="column-title">üìã Tax Strategy <span class="column-count" id="count-tax">0</span></span>
                    <button class="add-btn" onclick="openAddModal('tax')">+</button>
                </div>
                <div class="card-list" id="list-tax"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="item-modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">Add Item</h2>
            <input type="hidden" id="item-id">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="item-title" placeholder="Item title">
            </div>
            <div class="form-group">
                <label>Content</label>
                <textarea id="item-content" placeholder="Details, insights, data..."></textarea>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="item-category">
                    <option value="housing">Housing</option>
                    <option value="economics">Economics</option>
                    <option value="deepwork">Deep Work</option>
                    <option value="tax">Tax Strategy</option>
                </select>
            </div>
            <div class="form-group">
                <label>Source</label>
                <input type="text" id="item-source" placeholder="e.g., Grok Dec 27, 2025">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveItem()">Save</button>
            </div>
        </div>
    </div>
    
    <footer>Multi-City Living Research ‚Ä¢ Business Analyst Agent ‚Ä¢ Tony's Dashboard</footer>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://glihiakqispoxwyfzhoi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsaWhpYWtxaXNwb3h3eWZ6aG9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTM5NjgsImV4cCI6MjA4Njc2OTk2OH0.vacX_vZebmLF4YTCj8rHfTUCycPjLf7MNKtUPNYTyBQ';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const BOARD_NAME = 'multi-city';
        
        let items = [];
        const CATEGORIES = ['housing', 'economics', 'deepwork', 'tax'];
        
        async function init() {
            await loadData();
            renderBoard();
            initSortable();
        }
        
        async function loadData() {
            try {
                const { data, error } = await db
                    .from('kanban_items')
                    .select('*')
                    .eq('board', BOARD_NAME)
                    .order('position', { ascending: true });
                
                if (error) throw error;
                
                items = data.map(item => ({
                    id: item.item_id || item.id,
                    supabaseId: item.id,
                    category: item.column_id,
                    position: item.position,
                    ...(typeof item.data === 'string' ? JSON.parse(item.data) : item.data)
                }));
                
                console.log(`Loaded ${items.length} items from Supabase`);
            } catch (e) {
                console.error('Failed to load:', e);
                items = [];
            }
        }
        
        async function saveItemToSupabase(item, isNew = false) {
            const itemData = { title: item.title, content: item.content, source: item.source };
            try {
                if (isNew) {
                    const { error } = await db.from('kanban_items').insert({
                        board: BOARD_NAME, column_id: item.category, item_id: String(item.id),
                        position: items.length, data: itemData
                    });
                    if (error) throw error;
                } else {
                    const { error } = await db.from('kanban_items').update({
                        column_id: item.category, data: itemData
                    }).eq('board', BOARD_NAME).eq('item_id', String(item.id));
                    if (error) throw error;
                }
            } catch (e) { console.error('Save failed:', e); }
        }
        
        async function updateItemCategory(itemId, newCategory) {
            try {
                const { error } = await db.from('kanban_items').update({ column_id: newCategory })
                    .eq('board', BOARD_NAME).eq('item_id', String(itemId));
                if (error) throw error;
            } catch (e) { console.error('Update failed:', e); }
        }
        
        function renderBoard() {
            CATEGORIES.forEach(cat => {
                const list = document.getElementById(`list-${cat}`);
                const catItems = items.filter(i => i.category === cat);
                
                list.innerHTML = catItems.map(item => `
                    <div class="item-card" data-id="${item.id}" onclick="openEditModal('${item.id}')">
                        <div class="card-title">${escapeHtml(item.title || '')}</div>
                        <div class="card-content">${escapeHtml((item.content || '').substring(0, 150))}${(item.content || '').length > 150 ? '...' : ''}</div>
                        <div class="card-meta">
                            <span class="tag tag-${cat}">${cat}</span>
                            ${item.source ? `<span class="tag" style="background:rgba(255,255,255,0.1);color:#888;">${escapeHtml(item.source)}</span>` : ''}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById(`count-${cat}`).textContent = catItems.length;
            });
        }
        
        function initSortable() {
            document.querySelectorAll('.card-list').forEach(list => {
                new Sortable(list, {
                    group: 'research',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async function(evt) {
                        const itemId = evt.item.dataset.id;
                        const newCategory = evt.to.id.replace('list-', '');
                        const item = items.find(i => String(i.id) === itemId);
                        if (item) {
                            item.category = newCategory;
                            await updateItemCategory(itemId, newCategory);
                            renderBoard();
                        }
                    }
                });
            });
        }
        
        function openAddModal(category = 'housing') {
            document.getElementById('modal-title').textContent = 'Add Item';
            document.getElementById('item-id').value = '';
            document.getElementById('item-title').value = '';
            document.getElementById('item-content').value = '';
            document.getElementById('item-category').value = category;
            document.getElementById('item-source').value = '';
            document.getElementById('item-modal').classList.add('visible');
        }
        
        function openEditModal(id) {
            const item = items.find(i => String(i.id) === String(id));
            if (!item) return;
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-title').value = item.title || '';
            document.getElementById('item-content').value = item.content || '';
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-source').value = item.source || '';
            document.getElementById('item-modal').classList.add('visible');
        }
        
        function closeModal() { document.getElementById('item-modal').classList.remove('visible'); }
        
        async function saveItem() {
            const id = document.getElementById('item-id').value;
            const title = document.getElementById('item-title').value.trim();
            if (!title) { alert('Title required'); return; }
            
            const itemData = {
                title,
                content: document.getElementById('item-content').value.trim(),
                category: document.getElementById('item-category').value,
                source: document.getElementById('item-source').value.trim()
            };
            
            if (id) {
                const item = items.find(i => String(i.id) === String(id));
                if (item) { Object.assign(item, itemData); await saveItemToSupabase(item, false); }
            } else {
                itemData.id = Date.now();
                items.push(itemData);
                await saveItemToSupabase(itemData, true);
            }
            
            renderBoard();
            closeModal();
        }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `multi-city-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        document.getElementById('item-modal').addEventListener('click', e => { if (e.target.id === 'item-modal') closeModal(); });
        init();
    </script>
</body>
</html>
