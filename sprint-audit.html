<!-- Protected by Vercel middleware.js -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“‹ Sprint Audit Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4aa, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: #2a2a3e;
        }

        .filter-btn.active {
            background: #00d4aa;
            color: #000;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }

        .metric-trend {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .good { color: #00d4aa; background: rgba(0, 212, 170, 0.1); }
        .amber { color: #ffa500; background: rgba(255, 165, 0, 0.1); }
        .red { color: #ff4757; background: rgba(255, 71, 87, 0.1); }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            border: 2px solid #333;
            border-top: 2px solid #00d4aa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .audit-table-container {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-table th {
            background: #16213e;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.2s ease;
        }

        .audit-table th:hover {
            background: #1e2a4e;
        }

        .audit-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
        }

        .audit-table tr:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        .issue-id {
            color: #00d4aa;
            text-decoration: none;
            font-weight: 500;
        }

        .issue-id:hover {
            text-decoration: underline;
        }

        .timeline-container {
            margin-top: 30px;
        }

        .timeline-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .timeline-bar {
            height: 20px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            margin-top: 5px;
        }

        .timeline-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .waiting { background: #666; }
        .queued { background: #3498db; }
        .active { background: #27ae60; }
        .review { background: #f39c12; }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4aa;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                font-size: 2rem;
            }

            .metrics-row {
                grid-template-columns: 1fr;
            }

            .audit-table-container {
                overflow-x: auto;
            }

            .audit-table {
                min-width: 800px;
            }
        }

        .error {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‹ Sprint Audit</h1>
            <div class="filters">
                <button class="filter-btn active" data-range="7">Last 7 Days</button>
                <button class="filter-btn" data-range="30">Last 30 Days</button>
                <button class="filter-btn" data-range="all">All Time</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading sprint data from Linear...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- Summary Metrics -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div id="totalCompleted" class="metric-value">-</div>
                    <div class="metric-label">Total Issues Completed</div>
                    <div id="completedTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="leadTime" class="metric-value">-</div>
                    <div class="metric-label">Lead Time (avg)</div>
                    <div id="leadTimeTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="cycleTime" class="metric-value">-</div>
                    <div class="metric-label">Cycle Time (avg)</div>
                    <div id="cycleTimeTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="waitTime" class="metric-value">-</div>
                    <div class="metric-label">Wait Time (avg)</div>
                    <div id="waitTimeTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="reworkRate" class="metric-value">-</div>
                    <div class="metric-label">Rework Rate</div>
                    <div id="reworkTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="firstPassRate" class="metric-value">-</div>
                    <div class="metric-label">First-Pass Rate</div>
                    <div id="firstPassTrend" class="metric-trend"></div>
                </div>
            </div>

            <!-- Flow Metrics -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div id="flowEfficiency" class="metric-value">-</div>
                    <div class="metric-label">Flow Efficiency</div>
                    <div id="flowTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="throughput" class="metric-value">-</div>
                    <div class="metric-label">Throughput (per day)</div>
                    <div id="throughputTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="wip" class="metric-value">-</div>
                    <div class="metric-label">WIP (In Progress)</div>
                    <div id="wipTrend" class="metric-trend"></div>
                </div>
            </div>

            <!-- Escalation Summary -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div id="totalEscalations" class="metric-value">-</div>
                    <div class="metric-label">Total Escalations</div>
                    <div id="escalationTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="resolvedEscalations" class="metric-value">-</div>
                    <div class="metric-label">Resolved vs Open</div>
                    <div id="resolvedTrend" class="metric-trend"></div>
                </div>
                <div class="metric-card">
                    <div id="avgResolutionTime" class="metric-value">-</div>
                    <div class="metric-label">Avg Resolution Time</div>
                    <div id="resolutionTrend" class="metric-trend"></div>
                </div>
            </div>

            <!-- Issue Audit Trail -->
            <div class="section-title">Issue Audit Trail</div>
            <div class="audit-table-container">
                <table class="audit-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Issue ID</th>
                            <th onclick="sortTable(1)">Title</th>
                            <th onclick="sortTable(2)">Squad</th>
                            <th onclick="sortTable(3)">Lead Time</th>
                            <th onclick="sortTable(4)">Cycle Time</th>
                            <th onclick="sortTable(5)">Rework Count</th>
                            <th onclick="sortTable(6)">Contract Status</th>
                            <th onclick="sortTable(7)">Escalated?</th>
                            <th onclick="sortTable(8)">Completed Date</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody"></tbody>
                </table>
            </div>

            <!-- Timeline Chart -->
            <div class="section-title">Issue Lifecycle Timeline</div>
            <div id="timelineContainer" class="timeline-container"></div>
        </div>
    </div>

    <script>
        const LINEAR_API_ENDPOINT = 'https://api.linear.app/graphql';
        const LINEAR_API_KEY = ''; // Set via environment or prompt
        const TEAM_ID = 'de650b93-77f0-439d-a11f-de87c62c6f6d';
        const ESCALATION_LABEL_ID = '4e04565e-36b5-437c-a259-4b5170a13fbf';

        let currentRange = 7;
        let issuesData = [];
        let sortColumn = 8; // Default sort by completed date
        let sortDirection = -1; // Descending

        async function fetchLinearData() {
            const query = `
                query GetTeamIssues($teamId: String!) {
                    team(id: $teamId) {
                        issues(first: 200, filter: { completedAt: { null: false } }, orderBy: completedAt) {
                            nodes {
                                id
                                identifier
                                title
                                state { name }
                                labels { nodes { id name } }
                                createdAt
                                completedAt
                                startedAt
                                history(first: 100) {
                                    nodes {
                                        createdAt
                                        fromState { name }
                                        toState { name }
                                    }
                                }
                                comments(first: 50) {
                                    nodes {
                                        body
                                        createdAt
                                    }
                                }
                            }
                        }
                        issues(first: 200, filter: { state: { name: { in: ["In Progress"] } } }) {
                            nodes {
                                id
                                identifier
                                title
                                state { name }
                            }
                        }
                    }
                }
            `;

            try {
                const response = await fetch(LINEAR_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': LINEAR_API_KEY,
                    },
                    body: JSON.stringify({
                        query,
                        variables: { teamId: TEAM_ID }
                    })
                });

                const data = await response.json();
                if (data.errors) {
                    throw new Error(data.errors[0].message);
                }

                return data.data.team;
            } catch (error) {
                console.error('Error fetching Linear data:', error);
                throw error;
            }
        }

        function parseTimeString(timeStr) {
            return new Date(timeStr).getTime();
        }

        function formatDuration(hours) {
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${Math.round(hours * 10) / 10}h`;
            return `${Math.round(hours / 24 * 10) / 10}d`;
        }

        function calculateMetrics(issues) {
            const now = Date.now();
            const cutoffTime = currentRange === 'all' ? 0 : 
                now - (currentRange * 24 * 60 * 60 * 1000);

            const filteredIssues = issues.filter(issue => 
                issue.completedAt && parseTimeString(issue.completedAt) > cutoffTime
            );

            const processedIssues = filteredIssues.map(issue => {
                const createdTime = parseTimeString(issue.createdAt);
                const completedTime = parseTimeString(issue.completedAt);
                const startedTime = issue.startedAt ? parseTimeString(issue.startedAt) : createdTime;

                // Calculate times in hours
                const leadTime = (completedTime - createdTime) / (1000 * 60 * 60);
                const cycleTime = (completedTime - startedTime) / (1000 * 60 * 60);
                const waitTime = leadTime - cycleTime;

                // Calculate rework from history
                let reworkCount = 0;
                const history = issue.history.nodes.sort((a, b) => 
                    parseTimeString(a.createdAt) - parseTimeString(b.createdAt)
                );
                
                for (let i = 0; i < history.length; i++) {
                    const h = history[i];
                    if (h.fromState?.name === 'In Review' && h.toState?.name === 'In Progress') {
                        reworkCount++;
                    }
                }

                // Check for first-pass success
                const firstPass = reworkCount === 0;

                // Check for escalation
                const isEscalated = issue.labels.nodes.some(label => 
                    label.id === ESCALATION_LABEL_ID
                );

                // Check contract status from comments
                let contractStatus = 'Unknown';
                for (const comment of issue.comments.nodes) {
                    if (comment.body.includes('ðŸ“œ CONTRACT')) {
                        contractStatus = 'Contract';
                    }
                    if (comment.body.includes('âœ… ACCEPT')) {
                        contractStatus = 'Accepted';
                        break;
                    }
                }

                // Extract squad from labels
                const squad = issue.labels.nodes.find(label => 
                    label.name.includes('Squad')
                )?.name || 'None';

                return {
                    ...issue,
                    leadTime,
                    cycleTime,
                    waitTime,
                    reworkCount,
                    firstPass,
                    isEscalated,
                    contractStatus,
                    squad,
                    completedTime
                };
            });

            const totalCompleted = processedIssues.length;
            const avgLeadTime = processedIssues.length > 0 ? 
                processedIssues.reduce((sum, i) => sum + i.leadTime, 0) / processedIssues.length : 0;
            const avgCycleTime = processedIssues.length > 0 ?
                processedIssues.reduce((sum, i) => sum + i.cycleTime, 0) / processedIssues.length : 0;
            const avgWaitTime = avgLeadTime - avgCycleTime;
            const reworkRate = processedIssues.length > 0 ?
                processedIssues.filter(i => i.reworkCount > 0).length / processedIssues.length * 100 : 0;
            const firstPassRate = processedIssues.length > 0 ?
                processedIssues.filter(i => i.firstPass).length / processedIssues.length * 100 : 0;
            const flowEfficiency = avgLeadTime > 0 ? (avgCycleTime / avgLeadTime) * 100 : 0;

            const daysInRange = currentRange === 'all' ? 
                (now - Math.min(...processedIssues.map(i => i.completedTime))) / (1000 * 60 * 60 * 24) :
                currentRange;
            const throughput = daysInRange > 0 ? totalCompleted / daysInRange : 0;

            const escalatedIssues = processedIssues.filter(i => i.isEscalated);
            const totalEscalations = escalatedIssues.length;
            const resolvedEscalations = escalatedIssues.filter(i => 
                i.state.name === 'Done' || i.state.name === 'Cancelled'
            ).length;
            const avgResolutionTime = escalatedIssues.length > 0 ?
                escalatedIssues.reduce((sum, i) => sum + i.leadTime, 0) / escalatedIssues.length : 0;

            return {
                totalCompleted,
                avgLeadTime,
                avgCycleTime,
                avgWaitTime,
                reworkRate,
                firstPassRate,
                flowEfficiency,
                throughput,
                totalEscalations,
                resolvedEscalations,
                avgResolutionTime,
                processedIssues
            };
        }

        function getMetricClass(metric, value) {
            switch (metric) {
                case 'leadTime':
                    return value < 4 ? 'good' : value < 12 ? 'amber' : 'red';
                case 'reworkRate':
                    return value < 10 ? 'good' : value < 25 ? 'amber' : 'red';
                case 'flowEfficiency':
                    return value > 70 ? 'good' : value > 40 ? 'amber' : 'red';
                case 'firstPassRate':
                    return value > 80 ? 'good' : value > 60 ? 'amber' : 'red';
                default:
                    return 'good';
            }
        }

        function updateDashboard(teamData) {
            const completedIssues = teamData.issues.nodes;
            const wipIssues = teamData.issues.nodes; // Second query result for WIP
            
            const metrics = calculateMetrics(completedIssues);
            issuesData = metrics.processedIssues;

            // Update summary metrics
            document.getElementById('totalCompleted').textContent = metrics.totalCompleted;
            document.getElementById('leadTime').textContent = formatDuration(metrics.avgLeadTime);
            document.getElementById('cycleTime').textContent = formatDuration(metrics.avgCycleTime);
            document.getElementById('waitTime').textContent = formatDuration(metrics.avgWaitTime);
            document.getElementById('reworkRate').textContent = `${Math.round(metrics.reworkRate)}%`;
            document.getElementById('firstPassRate').textContent = `${Math.round(metrics.firstPassRate)}%`;

            // Update flow metrics
            document.getElementById('flowEfficiency').textContent = `${Math.round(metrics.flowEfficiency)}%`;
            document.getElementById('throughput').textContent = Math.round(metrics.throughput * 10) / 10;
            document.getElementById('wip').textContent = wipIssues.filter(i => i.state.name === 'In Progress').length;

            // Update escalation metrics
            document.getElementById('totalEscalations').textContent = metrics.totalEscalations;
            document.getElementById('resolvedEscalations').textContent = 
                `${metrics.resolvedEscalations} / ${metrics.totalEscalations}`;
            document.getElementById('avgResolutionTime').textContent = formatDuration(metrics.avgResolutionTime);

            // Apply metric classes
            document.getElementById('leadTimeTrend').className = 
                `metric-trend ${getMetricClass('leadTime', metrics.avgLeadTime)}`;
            document.getElementById('reworkTrend').className = 
                `metric-trend ${getMetricClass('reworkRate', metrics.reworkRate)}`;
            document.getElementById('flowTrend').className = 
                `metric-trend ${getMetricClass('flowEfficiency', metrics.flowEfficiency)}`;
            document.getElementById('firstPassTrend').className = 
                `metric-trend ${getMetricClass('firstPassRate', metrics.firstPassRate)}`;

            updateAuditTable();
            updateTimeline();
        }

        function updateAuditTable() {
            const tbody = document.getElementById('auditTableBody');
            const sortedIssues = [...issuesData].sort((a, b) => {
                let aVal, bVal;
                switch (sortColumn) {
                    case 0: aVal = a.identifier; bVal = b.identifier; break;
                    case 1: aVal = a.title; bVal = b.title; break;
                    case 2: aVal = a.squad; bVal = b.squad; break;
                    case 3: aVal = a.leadTime; bVal = b.leadTime; break;
                    case 4: aVal = a.cycleTime; bVal = b.cycleTime; break;
                    case 5: aVal = a.reworkCount; bVal = b.reworkCount; break;
                    case 6: aVal = a.contractStatus; bVal = b.contractStatus; break;
                    case 7: aVal = a.isEscalated; bVal = b.isEscalated; break;
                    case 8: aVal = a.completedTime; bVal = b.completedTime; break;
                    default: aVal = a.completedTime; bVal = b.completedTime;
                }
                
                if (typeof aVal === 'string') {
                    return sortDirection * aVal.localeCompare(bVal);
                }
                return sortDirection * (aVal - bVal);
            });

            tbody.innerHTML = sortedIssues.map(issue => `
                <tr>
                    <td><a href="https://linear.app/vtkl-greg/issue/${issue.identifier}" target="_blank" class="issue-id">${issue.identifier}</a></td>
                    <td>${issue.title}</td>
                    <td>${issue.squad}</td>
                    <td>${formatDuration(issue.leadTime)}</td>
                    <td>${formatDuration(issue.cycleTime)}</td>
                    <td>${issue.reworkCount}</td>
                    <td>${issue.contractStatus}</td>
                    <td>${issue.isEscalated ? 'Yes' : 'No'}</td>
                    <td>${new Date(issue.completedTime).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        function updateTimeline() {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = issuesData.slice(0, 20).map(issue => {
                const totalTime = issue.leadTime;
                const waitPercent = (issue.waitTime / totalTime) * 100;
                const activePercent = (issue.cycleTime / totalTime) * 100;
                
                return `
                    <div class="timeline-item">
                        <div style="font-weight: 500;">${issue.identifier}: ${issue.title}</div>
                        <div class="timeline-bar">
                            <div class="timeline-segment waiting" style="width: ${waitPercent}%"></div>
                            <div class="timeline-segment active" style="width: ${activePercent}%"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                            Total: ${formatDuration(issue.leadTime)} | Active: ${formatDuration(issue.cycleTime)} | Wait: ${formatDuration(issue.waitTime)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection *= -1;
            } else {
                sortColumn = column;
                sortDirection = 1;
            }
            updateAuditTable();
        }

        // Event listeners
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentRange = btn.dataset.range === 'all' ? 'all' : parseInt(btn.dataset.range);
                
                // Re-calculate metrics with new range
                const teamData = window.cachedTeamData;
                if (teamData) {
                    updateDashboard(teamData);
                }
            });
        });

        // Load data on page load
        async function init() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('error').style.display = 'none';

                const teamData = await fetchLinearData();
                window.cachedTeamData = teamData;
                
                updateDashboard(teamData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
            }
        }

        init();
    </script>
</body>
</html>